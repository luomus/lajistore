version: 2

variables:
  testUrl: http://store-api:3000
  authorization: 'Basic S0UuMDA3OnBhc3N3b3Jk'

requests:
  unknown_type_returns_404:
    request:
      url: <$ testUrl $>/FOOBAR
      method: GET
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 404

  not_auth_type_returns_401:
    request:
      url: <$ testUrl $>/FOOBAR
      method: GET
    validate:
      - jsonpath: status
        expect: 401

  json_ld_dont_require_login:
    request:
      url: <$ testUrl $>/json-ld-context/MY.document
      method: GET
    validate:
      - jsonpath: status
        expect: 200

  can_find_type_with_json_suffix:
    request:
      url: <$ testUrl $>/json-ld-context/document.json
      method: GET
    validate:
      - jsonpath: status
        expect: 200

  non_existsing_returns_404:
    request:
      url: <$ testUrl $>/json-ld-context/foobar.json
      method: GET
    validate:
      - jsonpath: status
        expect: 404

  json_schema_dont_require_login:
    request:
      url: <$ testUrl $>/json-schema/MY.unit
      method: GET
    validate:
      - jsonpath: status
        expect: 200

  es_mapping_dont_require_login:
    request:
      url: <$ testUrl $>/es-mapping/MY.gathering.json
      method: GET
    validate:
      - jsonpath: status
        expect: 200

  status_dont_require_login:
    request:
      url: <$ testUrl $>/status
      method: GET
    validate:
      - jsonpath: status
        expect: 200

  ping_dont_require_login:
    request:
      url: <$ testUrl $>/status
      method: GET
    validate:
      - jsonpath: status
        expect: 200

  bulk_requires_login:
    request:
      url: <$ testUrl $>/_bulk
      method: POST
      json: apps/store-api/test/utilities/bulk-data.json
    validate:
      - jsonpath: status
        expect: 401

  no_invalid_bulk_1:
    request:
      url: <$ testUrl $>/_bulk
      method: POST
      json: apps/store-api/test/utilities/bulk-invalid-1.json
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 422

  no_invalid_bulk_2:
    request:
      url: <$ testUrl $>/_bulk
      method: POST
      json: apps/store-api/test/utilities/bulk-invalid-2.json
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 422

  adding_with_bulk:
    request:
      url: <$ testUrl $>/_bulk
      method: POST
      json: apps/store-api/test/utilities/bulk-data.json
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 201

  check_data_exists:
    request:
      url: <$ testUrl $>/device/JX.001
      method: GET
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 200
      - jsonpath: content.deviceType
        expect: "satellite"

  update_with_bulk:
    request:
      url: <$ testUrl $>/_bulk
      method: POST
      json: apps/store-api/test/utilities/bulk-updated-data.json
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 201

  check_update_data:
    request:
      url: <$ testUrl $>/device/JX.001
      method: GET
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 200
      - jsonpath: content.deviceType
        expect: "drone"

  accessing_sequence_without_auth_returns_401:
    request:
      url: <$ testUrl $>/sequence/test/next
      method: GET
    validate:
      - jsonpath: status
        expect: 401

  requesting_next_for_nonexisting_seq_throws_404:
    request:
      url: <$ testUrl $>/sequence/test/next
      method: GET
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 404

  requesting_next_with_createIfMissing_returns_1:
    request:
      url: <$ testUrl $>/sequence/test/next
      method: GET
      queryString:
        - name: createIfMissing
          value: "true"
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 200
      - jsonpath: content
        expect: 1

  requesting_next_for_created_results_next_value:
    request:
      url: <$ testUrl $>/sequence/test/next
      method: GET
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 200
      - jsonpath: content
        expect: 2

  trying_to_create_sequence_without_auth_gives_401:
    request:
      url: <$ testUrl $>/sequence
      method: POST
      postData:
        mimeType: application/json
        text:
          key: "test2"
    validate:
      - jsonpath: status
        expect: 401

  trying_to_create_sequence_with_auth_results_in_204:
    request:
      url: <$ testUrl $>/sequence
      method: POST
      postData:
        mimeType: application/json
        text:
          key: "test2"
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 204

  getting_next_from_sequence_without_initial_value_gives_1:
    request:
      url: <$ testUrl $>/sequence/test2/next
      method: GET
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 200
      - jsonpath: content
        expect: 1

  trying_to_create_sequence_with initial_value_204:
    request:
      url: <$ testUrl $>/sequence
      method: POST
      postData:
        mimeType: application/json
        text:
          key: test3
          next: 50
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 204

  next_value_from_sequence_with initial_value_return_correct:
    request:
      url: <$ testUrl $>/sequence/test3/next
      method: GET
      headers:
        - name: authorization
          value: <$ authorization $>
    validate:
      - jsonpath: status
        expect: 200
      - jsonpath: content
        expect: 50
